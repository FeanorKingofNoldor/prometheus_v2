<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4190px" preserveAspectRatio="none" style="width:2635px;height:4190px;" version="1.1" viewBox="0 0 2635 4190" width="2635px" zoomAndPan="magnify"><defs><filter height="300%" id="f19844tg0jdx0b" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="450" x="1088.25" y="29.2419">Prometheus v2 - Backtesting Flow with TimeMachine</text><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="931.3564" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="177.5" y="295.5259"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="121.118" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="458.5" y="327.2319"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="143.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="458.5" y="749.9981"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="125.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="458.5" y="979.9402"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="278.6481" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="752.5" y="948.2342"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="112.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="943.5" y="1258.5883"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="112.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1133.5" y="1537.2365"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="63.412" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1413.5" y="1860.5906"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="112.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1625.5" y="2089.8267"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="63.412" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1844.5" y="2368.4748"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="165.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2055.5" y="480.056"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="121.118" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2055.5" y="2579.7109"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="399.4722" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2055.5" y="2739.535"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="112.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2278.5" y="2797.947"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="2940.0114" style="stroke: #000000; stroke-width: 2.0;" width="2600.5" x="13" y="706.586"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="172.5301" style="stroke: #000000; stroke-width: 2.0;" width="2159" x="110.5" y="2536.2989"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="526.5902" style="stroke: #000000; stroke-width: 2.0;" width="2493" x="110.5" y="2754.535"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="41" x2="41" y1="127.5838" y2="4100.5997"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="182.5" x2="182.5" y1="127.5838" y2="4100.5997"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="463" x2="463" y1="127.5838" y2="4100.5997"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="757.5" x2="757.5" y1="127.5838" y2="4100.5997"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="948" x2="948" y1="127.5838" y2="4100.5997"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1138" x2="1138" y1="127.5838" y2="4100.5997"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1418.5" x2="1418.5" y1="127.5838" y2="4100.5997"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1630" x2="1630" y1="127.5838" y2="4100.5997"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1849.5" x2="1849.5" y1="127.5838" y2="4100.5997"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2060.5" x2="2060.5" y1="127.5838" y2="4100.5997"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2283.5" x2="2283.5" y1="127.5838" y2="4100.5997"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2547.5" x2="2547.5" y1="127.5838" y2="4100.5997"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="23" y="123.4818">User</text><ellipse cx="41.5" cy="51.5158" fill="#FEFECE" filter="url(#f19844tg0jdx0b)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M41.5,59.5158 L41.5,86.5158 M28.5,67.5158 L54.5,67.5158 M41.5,86.5158 L28.5,101.5158 M41.5,86.5158 L54.5,101.5158 " fill="none" filter="url(#f19844tg0jdx0b)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="23" y="4114.5657">User</text><ellipse cx="41.5" cy="4128.6676" fill="#FEFECE" filter="url(#f19844tg0jdx0b)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M41.5,4136.6676 L41.5,4163.6676 M28.5,4144.6676 L54.5,4144.6676 M41.5,4163.6676 L28.5,4178.6676 M41.5,4163.6676 L54.5,4178.6676 " fill="none" filter="url(#f19844tg0jdx0b)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="120.5" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="127.5" y="111.4818">BacktestRunner</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="120.5" y="4099.5997"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="127.5" y="4121.5657">BacktestRunner</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="105" x="409" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="416" y="111.4818">TimeMachine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="105" x="409" y="4099.5997"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="416" y="4121.5657">TimeMachine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="112" x="699.5" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="706.5" y="111.4818">RegimeEngine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="112" x="699.5" y="4099.5997"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="706.5" y="4121.5657">RegimeEngine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="889" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="896" y="111.4818">StabilityEngine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="889" y="4099.5997"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="896" y="4121.5657">StabilityEngine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="1066" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="1073" y="111.4818">AssessmentEngine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="1066" y="4099.5997"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="1073" y="4121.5657">AssessmentEngine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="1356.5" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="1363.5" y="111.4818">UniverseEngine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="1356.5" y="4099.5997"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="1363.5" y="4121.5657">UniverseEngine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="1570" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="1577" y="111.4818">PortfolioEngine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="1570" y="4099.5997"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="1577" y="4121.5657">PortfolioEngine</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="1794.5" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1801.5" y="111.4818">OrderPlanner</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="1794.5" y="4099.5997"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1801.5" y="4121.5657">OrderPlanner</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="2001.5" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="2008.5" y="111.4818">BacktestBroker</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="2001.5" y="4099.5997"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="2008.5" y="4121.5657">BacktestBroker</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="126" x="2218.5" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="112" x="2225.5" y="111.4818">MarketSimulator</text><rect fill="#FEFECE" filter="url(#f19844tg0jdx0b)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="126" x="2218.5" y="4099.5997"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="112" x="2225.5" y="4121.5657">MarketSimulator</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="2501.5" y="123.4818">historical_db</text><path d="M2529.5,72.5158 C2529.5,62.5158 2547.5,62.5158 2547.5,62.5158 C2547.5,62.5158 2565.5,62.5158 2565.5,72.5158 L2565.5,98.5158 C2565.5,108.5158 2547.5,108.5158 2547.5,108.5158 C2547.5,108.5158 2529.5,108.5158 2529.5,98.5158 L2529.5,72.5158 " fill="#FEFECE" filter="url(#f19844tg0jdx0b)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M2529.5,72.5158 C2529.5,82.5158 2547.5,82.5158 2547.5,82.5158 C2547.5,82.5158 2565.5,82.5158 2565.5,72.5158 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="2501.5" y="4114.5657">historical_db</text><path d="M2529.5,4128.6676 C2529.5,4118.6676 2547.5,4118.6676 2547.5,4118.6676 C2547.5,4118.6676 2565.5,4118.6676 2565.5,4128.6676 L2565.5,4154.6676 C2565.5,4164.6676 2547.5,4164.6676 2547.5,4164.6676 C2547.5,4164.6676 2529.5,4164.6676 2529.5,4154.6676 L2529.5,4128.6676 " fill="#FEFECE" filter="url(#f19844tg0jdx0b)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M2529.5,4128.6676 C2529.5,4138.6676 2547.5,4138.6676 2547.5,4138.6676 C2547.5,4138.6676 2565.5,4138.6676 2565.5,4128.6676 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="931.3564" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="177.5" y="295.5259"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="121.118" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="458.5" y="327.2319"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="143.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="458.5" y="749.9981"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="125.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="458.5" y="979.9402"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="278.6481" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="752.5" y="948.2342"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="112.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="943.5" y="1258.5883"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="112.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1133.5" y="1537.2365"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="63.412" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1413.5" y="1860.5906"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="112.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1625.5" y="2089.8267"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="63.412" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1844.5" y="2368.4748"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="165.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2055.5" y="480.056"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="121.118" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2055.5" y="2579.7109"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="399.4722" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2055.5" y="2739.535"/><rect fill="#FFFFFF" filter="url(#f19844tg0jdx0b)" height="112.8241" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2278.5" y="2797.947"/><rect fill="#EEEEEE" filter="url(#f19844tg0jdx0b)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2620.5" x="3" y="159.4368"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2623.5" y1="159.4368" y2="159.4368"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2623.5" y1="162.4368" y2="162.4368"/><rect fill="#EEEEEE" filter="url(#f19844tg0jdx0b)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="163" x="1231.75" y="147.5838"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="1237.75" y="165.4808">Backtest Initialization</text><polygon fill="#A80036" points="165.5,291.5259,175.5,295.5259,165.5,299.5259,169.5,295.5259" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="41.5" x2="171.5" y1="295.5259" y2="295.5259"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="48.5" y="201.1868">run_backtest(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="54.5" y="218.8928">start=2020-01-01,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="54.5" y="236.5988">end=2023-12-31,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="54.5" y="254.3048">strategy="main",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="54.5" y="272.0109">initial_cash=1M</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="48.5" y="289.7169">)</text><polygon fill="#A80036" points="446.5,323.2319,456.5,327.2319,446.5,331.2319,450.5,327.2319" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="187.5" x2="452.5" y1="327.2319" y2="327.2319"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="19" x="194.5" y="321.4229">init</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="213.5" y="321.4229">(start_date, end_date)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="468.5" x2="510.5" y1="358.9379" y2="358.9379"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="510.5" x2="510.5" y1="358.9379" y2="371.9379"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="469.5" x2="510.5" y1="371.9379" y2="371.9379"/><polygon fill="#A80036" points="479.5,367.9379,469.5,371.9379,479.5,375.9379,475.5,371.9379" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="475.5" y="353.1289">_load_trading_calendar()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="468.5" x2="510.5" y1="403.6439" y2="403.6439"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="510.5" x2="510.5" y1="403.6439" y2="416.6439"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="469.5" x2="510.5" y1="416.6439" y2="416.6439"/><polygon fill="#A80036" points="479.5,412.6439,469.5,416.6439,479.5,420.6439,475.5,416.6439" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="475.5" y="397.8349">current_date = start_date</text><polygon fill="#A80036" points="198.5,444.3499,188.5,448.3499,198.5,452.3499,194.5,448.3499" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="192.5" x2="462.5" y1="448.3499" y2="448.3499"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="204.5" y="442.5409">TimeMachine initialized</text><polygon fill="#A80036" points="2043.5,476.056,2053.5,480.056,2043.5,484.056,2047.5,480.056" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="187.5" x2="2049.5" y1="480.056" y2="480.056"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="19" x="194.5" y="474.247">init</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="213.5" y="474.247">(time_machine=TM, initial_cash=1M)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2065.5" x2="2107.5" y1="511.762" y2="511.762"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2107.5" x2="2107.5" y1="511.762" y2="524.762"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2066.5" x2="2107.5" y1="524.762" y2="524.762"/><polygon fill="#A80036" points="2076.5,520.762,2066.5,524.762,2076.5,528.762,2072.5,524.762" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="2072.5" y="505.953">portfolio_value = initial_cash</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2065.5" x2="2107.5" y1="556.468" y2="556.468"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2107.5" x2="2107.5" y1="556.468" y2="569.468"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2066.5" x2="2107.5" y1="569.468" y2="569.468"/><polygon fill="#A80036" points="2076.5,565.468,2066.5,569.468,2076.5,573.468,2072.5,569.468" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="2072.5" y="550.659">positions = {}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2065.5" x2="2107.5" y1="601.174" y2="601.174"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2107.5" x2="2107.5" y1="601.174" y2="614.174"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2066.5" x2="2107.5" y1="614.174" y2="614.174"/><polygon fill="#A80036" points="2076.5,610.174,2066.5,614.174,2076.5,618.174,2072.5,614.174" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="2072.5" y="595.365">pending_orders = []</text><polygon fill="#A80036" points="198.5,641.88,188.5,645.88,198.5,649.88,194.5,645.88" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="192.5" x2="2059.5" y1="645.88" y2="645.88"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="204.5" y="640.071">BacktestBroker initialized</text><rect fill="#EEEEEE" filter="url(#f19844tg0jdx0b)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2620.5" x="3" y="675.733"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2623.5" y1="675.733" y2="675.733"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2623.5" y1="678.733" y2="678.733"/><rect fill="#EEEEEE" filter="url(#f19844tg0jdx0b)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="145" x="1240.75" y="663.88"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="128" x="1246.75" y="681.777">Main Backtest Loop</text><path d="M13,706.586 L86,706.586 L86,715.586 L76,725.586 L13,725.586 L13,706.586 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2940.0114" style="stroke: #000000; stroke-width: 2.0;" width="2600.5" x="13" y="706.586"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="28" y="721.4831">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="101" y="720.345">[for each trading day in [2020-01-01, 2023-12-31]]</text><polygon fill="#A80036" points="446.5,745.9981,456.5,749.9981,446.5,753.9981,450.5,749.9981" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="187.5" x2="452.5" y1="749.9981" y2="749.9981"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="194.5" y="744.1891">set_date(current_date)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="468.5" x2="510.5" y1="781.7041" y2="781.7041"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="510.5" x2="510.5" y1="781.7041" y2="794.7041"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="469.5" x2="510.5" y1="794.7041" y2="794.7041"/><polygon fill="#A80036" points="479.5,790.7041,469.5,794.7041,479.5,798.7041,475.5,794.7041" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="475.5" y="775.8951">current_date = date</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="468.5" x2="510.5" y1="826.4101" y2="826.4101"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="510.5" x2="510.5" y1="826.4101" y2="839.4101"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="469.5" x2="510.5" y1="839.4101" y2="839.4101"/><polygon fill="#A80036" points="479.5,835.4101,469.5,839.4101,479.5,843.4101,475.5,839.4101" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="475.5" y="820.6011">_validate_no_lookahead()</text><polygon fill="#A80036" points="198.5,889.8221,188.5,893.8221,198.5,897.8221,194.5,893.8221" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="192.5" x2="462.5" y1="893.8221" y2="893.8221"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="204.5" y="888.0131">OK</text><path d="M473,852.4101 L473,915.4101 L653,915.4101 L653,862.4101 L643,852.4101 L473,852.4101 " fill="#FBFB77" filter="url(#f19844tg0jdx0b)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M643,852.4101 L643,862.4101 L653,862.4101 L643,852.4101 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="479" y="871.3071">All subsequent data access</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="479" y="889.0131">is gated by TimeMachine.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="479" y="906.7192">No future data accessible!</text><polygon fill="#A80036" points="740.5,944.2342,750.5,948.2342,740.5,952.2342,744.5,948.2342" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="187.5" x2="746.5" y1="948.2342" y2="948.2342"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="194.5" y="942.4252">get_regime(as_of_date=current_date, region="US")</text><polygon fill="#A80036" points="479.5,975.9402,469.5,979.9402,479.5,983.9402,475.5,979.9402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="473.5" x2="751.5" y1="979.9402" y2="979.9402"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="485.5" y="974.1312">get_data("prices_daily", filters={...})</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="468.5" x2="510.5" y1="1011.6462" y2="1011.6462"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="510.5" x2="510.5" y1="1011.6462" y2="1024.6462"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="469.5" x2="510.5" y1="1024.6462" y2="1024.6462"/><polygon fill="#A80036" points="479.5,1020.6462,469.5,1024.6462,479.5,1028.6462,475.5,1024.6462" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="475.5" y="1005.8372">_check_date_constraint(current_date)</text><polygon fill="#A80036" points="2535.5,1070.0582,2545.5,1074.0582,2535.5,1078.0582,2539.5,1074.0582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="468.5" x2="2541.5" y1="1074.0582" y2="1074.0582"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="475.5" y="1050.5432">SELECT * FROM prices_daily</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="481.5" y="1068.2492">WHERE date &lt;= current_date</text><polygon fill="#A80036" points="740.5,1101.7643,750.5,1105.7643,740.5,1109.7643,744.5,1105.7643" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="463.5" x2="746.5" y1="1105.7643" y2="1105.7643"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="470.5" y="1099.9553">DataFrame (time-gated)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="804.5" y1="1137.4703" y2="1137.4703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="804.5" x2="804.5" y1="1137.4703" y2="1150.4703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="763.5" x2="804.5" y1="1150.4703" y2="1150.4703"/><polygon fill="#A80036" points="773.5,1146.4703,763.5,1150.4703,773.5,1154.4703,769.5,1150.4703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="769.5" y="1131.6613">embed_regime_window(...)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="804.5" y1="1182.1763" y2="1182.1763"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="804.5" x2="804.5" y1="1182.1763" y2="1195.1763"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="763.5" x2="804.5" y1="1195.1763" y2="1195.1763"/><polygon fill="#A80036" points="773.5,1191.1763,763.5,1195.1763,773.5,1199.1763,769.5,1195.1763" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="769.5" y="1176.3673">classify_regime(embedding)</text><polygon fill="#A80036" points="52.5,1222.8823,42.5,1226.8823,52.5,1230.8823,48.5,1226.8823" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="46.5" x2="181.5" y1="1226.8823" y2="1226.8823"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="58.5" y="1221.0733">RegimeState</text><polygon fill="#A80036" points="931.5,1254.5883,941.5,1258.5883,931.5,1262.5883,935.5,1258.5883" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="937.5" y1="1258.5883" y2="1258.5883"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="189.5" y="1252.7793">compute_stability_batch(entities, current_date)</text><polygon fill="#A80036" points="474.5,1286.2943,464.5,1290.2943,474.5,1294.2943,470.5,1290.2943" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="468.5" x2="942.5" y1="1290.2943" y2="1290.2943"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="480.5" y="1284.4853">get_data("profiles", filters={...})</text><polygon fill="#A80036" points="2535.5,1335.7064,2545.5,1339.7064,2535.5,1343.7064,2539.5,1339.7064" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="463.5" x2="2541.5" y1="1339.7064" y2="1339.7064"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="470.5" y="1316.1914">SELECT * FROM profiles</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="476.5" y="1333.8974">WHERE as_of_date &lt;= current_date</text><polygon fill="#A80036" points="193.5,1367.4124,183.5,1371.4124,193.5,1375.4124,189.5,1371.4124" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="187.5" x2="947.5" y1="1371.4124" y2="1371.4124"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="199.5" y="1365.6034">List[ProfileSnapshot]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="990.5" y1="1403.1184" y2="1403.1184"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="990.5" x2="990.5" y1="1403.1184" y2="1416.1184"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="949.5" x2="990.5" y1="1416.1184" y2="1416.1184"/><polygon fill="#A80036" points="959.5,1412.1184,949.5,1416.1184,959.5,1420.1184,955.5,1416.1184" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="955.5" y="1397.3094">_compute_liquidity_score(...)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="990.5" y1="1447.8244" y2="1447.8244"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="990.5" x2="990.5" y1="1447.8244" y2="1460.8244"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="949.5" x2="990.5" y1="1460.8244" y2="1460.8244"/><polygon fill="#A80036" points="959.5,1456.8244,949.5,1460.8244,959.5,1464.8244,955.5,1460.8244" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="955.5" y="1442.0154">_compute_volatility_score(...)</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="948.5" x2="990.5" y1="1497.5304" y2="1497.5304"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="990.5" x2="990.5" y1="1497.5304" y2="1510.5304"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="943.5" x2="990.5" y1="1510.5304" y2="1510.5304"/><polygon fill="#A80036" points="953.5,1506.5304,943.5,1510.5304,953.5,1514.5304,949.5,1510.5304" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="955.5" y="1491.7214">Dict[entity_id, StabilityVector]</text><polygon fill="#A80036" points="1121.5,1533.2365,1131.5,1537.2365,1121.5,1541.2365,1125.5,1537.2365" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="1127.5" y1="1537.2365" y2="1537.2365"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="189.5" y="1531.4275">score_strategy_default("main", "US_EQ", current_date)</text><polygon fill="#A80036" points="474.5,1564.9425,464.5,1568.9425,474.5,1572.9425,470.5,1568.9425" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="468.5" x2="1132.5" y1="1568.9425" y2="1568.9425"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="480.5" y="1563.1335">get_data("returns_daily", filters={...})</text><polygon fill="#A80036" points="2535.5,1614.3545,2545.5,1618.3545,2535.5,1622.3545,2539.5,1618.3545" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="463.5" x2="2541.5" y1="1618.3545" y2="1618.3545"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="470.5" y="1594.8395">SELECT * FROM returns_daily</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="476.5" y="1612.5455">WHERE date &lt;= current_date</text><polygon fill="#A80036" points="193.5,1646.0605,183.5,1650.0605,193.5,1654.0605,189.5,1650.0605" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="187.5" x2="1137.5" y1="1650.0605" y2="1650.0605"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="199.5" y="1644.2515">DataFrame</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1138.5" x2="1180.5" y1="1681.7665" y2="1681.7665"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1180.5" x2="1180.5" y1="1681.7665" y2="1694.7665"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1139.5" x2="1180.5" y1="1694.7665" y2="1694.7665"/><polygon fill="#A80036" points="1149.5,1690.7665,1139.5,1694.7665,1149.5,1698.7665,1145.5,1694.7665" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1145.5" y="1675.9575">_compute_value_alpha(...)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1138.5" x2="1180.5" y1="1726.4726" y2="1726.4726"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1180.5" x2="1180.5" y1="1726.4726" y2="1739.4726"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1139.5" x2="1180.5" y1="1739.4726" y2="1739.4726"/><polygon fill="#A80036" points="1149.5,1735.4726,1139.5,1739.4726,1149.5,1743.4726,1145.5,1739.4726" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1145.5" y="1720.6636">_compute_momentum_alpha(...)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1138.5" x2="1180.5" y1="1771.1786" y2="1771.1786"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1180.5" x2="1180.5" y1="1771.1786" y2="1784.1786"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1139.5" x2="1180.5" y1="1784.1786" y2="1784.1786"/><polygon fill="#A80036" points="1149.5,1780.1786,1139.5,1784.1786,1149.5,1788.1786,1145.5,1784.1786" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1145.5" y="1765.3696">_combine_alphas(...)</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1138.5" x2="1180.5" y1="1820.8846" y2="1820.8846"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1180.5" x2="1180.5" y1="1820.8846" y2="1833.8846"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1133.5" x2="1180.5" y1="1833.8846" y2="1833.8846"/><polygon fill="#A80036" points="1143.5,1829.8846,1133.5,1833.8846,1143.5,1837.8846,1139.5,1833.8846" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="1145.5" y="1815.0756">Dict[instrument_id, InstrumentScore]</text><polygon fill="#A80036" points="1401.5,1856.5906,1411.5,1860.5906,1401.5,1864.5906,1405.5,1860.5906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="1407.5" y1="1860.5906" y2="1860.5906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="189.5" y="1854.7816">select("main", "US_EQ", current_date)</text><polygon fill="#A80036" points="1149.5,1888.2966,1139.5,1892.2966,1149.5,1896.2966,1145.5,1892.2966" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1143.5" x2="1412.5" y1="1892.2966" y2="1892.2966"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1155.5" y="1886.4876">get_scores("main", "US_EQ", current_date)</text><polygon fill="#A80036" points="193.5,1920.0026,183.5,1924.0026,193.5,1928.0026,189.5,1924.0026" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="187.5" x2="1417.5" y1="1924.0026" y2="1924.0026"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="199.5" y="1918.1936">Dict[instrument_id, InstrumentScore]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1418.5" x2="1460.5" y1="1955.7087" y2="1955.7087"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1460.5" x2="1460.5" y1="1955.7087" y2="1968.7087"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1419.5" x2="1460.5" y1="1968.7087" y2="1968.7087"/><polygon fill="#A80036" points="1429.5,1964.7087,1419.5,1968.7087,1429.5,1972.7087,1425.5,1968.7087" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1425.5" y="1949.8997">filter_by_liquidity(...)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1418.5" x2="1460.5" y1="2000.4147" y2="2000.4147"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1460.5" x2="1460.5" y1="2000.4147" y2="2013.4147"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1419.5" x2="1460.5" y1="2013.4147" y2="2013.4147"/><polygon fill="#A80036" points="1429.5,2009.4147,1419.5,2013.4147,1429.5,2017.4147,1425.5,2013.4147" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1425.5" y="1994.6057">_assign_tiers(...)</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1418.5" x2="1460.5" y1="2050.1207" y2="2050.1207"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1460.5" x2="1460.5" y1="2050.1207" y2="2063.1207"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1413.5" x2="1460.5" y1="2063.1207" y2="2063.1207"/><polygon fill="#A80036" points="1423.5,2059.1207,1413.5,2063.1207,1423.5,2067.1207,1419.5,2063.1207" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="1425.5" y="2044.3117">Universe(core, satellite, watchlist)</text><polygon fill="#A80036" points="1613.5,2085.8267,1623.5,2089.8267,1613.5,2093.8267,1617.5,2089.8267" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="1619.5" y1="2089.8267" y2="2089.8267"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="189.5" y="2084.0177">optimize("main", current_date, universe, scores)</text><polygon fill="#A80036" points="474.5,2117.5327,464.5,2121.5327,474.5,2125.5327,470.5,2121.5327" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="468.5" x2="1624.5" y1="2121.5327" y2="2121.5327"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="480.5" y="2115.7237">get_data("correlation_panels", filters={...})</text><polygon fill="#A80036" points="2535.5,2166.9448,2545.5,2170.9448,2535.5,2174.9448,2539.5,2170.9448" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="463.5" x2="2541.5" y1="2170.9448" y2="2170.9448"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="470.5" y="2147.4297">SELECT * FROM correlation_panels</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="476.5" y="2165.1358">WHERE end_date &lt;= current_date</text><polygon fill="#A80036" points="193.5,2198.6508,183.5,2202.6508,193.5,2206.6508,189.5,2202.6508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="187.5" x2="1629.5" y1="2202.6508" y2="2202.6508"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="199.5" y="2196.8418">correlation_matrix</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1630.5" x2="1672.5" y1="2234.3568" y2="2234.3568"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1672.5" x2="1672.5" y1="2234.3568" y2="2247.3568"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1631.5" x2="1672.5" y1="2247.3568" y2="2247.3568"/><polygon fill="#A80036" points="1641.5,2243.3568,1631.5,2247.3568,1641.5,2251.3568,1637.5,2247.3568" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="1637.5" y="2228.5478">_build_optimization_problem(...)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1630.5" x2="1672.5" y1="2279.0628" y2="2279.0628"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1672.5" x2="1672.5" y1="2279.0628" y2="2292.0628"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1631.5" x2="1672.5" y1="2292.0628" y2="2292.0628"/><polygon fill="#A80036" points="1641.5,2288.0628,1631.5,2292.0628,1641.5,2296.0628,1637.5,2292.0628" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="1637.5" y="2273.2538">_solve_cvxpy(problem)</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1630.5" x2="1672.5" y1="2328.7688" y2="2328.7688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1672.5" x2="1672.5" y1="2328.7688" y2="2341.7688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1625.5" x2="1672.5" y1="2341.7688" y2="2341.7688"/><polygon fill="#A80036" points="1635.5,2337.7688,1625.5,2341.7688,1635.5,2345.7688,1631.5,2341.7688" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="1637.5" y="2322.9598">Dict[instrument_id, target_weight]</text><polygon fill="#A80036" points="1832.5,2364.4748,1842.5,2368.4748,1832.5,2372.4748,1836.5,2368.4748" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="1838.5" y1="2368.4748" y2="2368.4748"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="189.5" y="2362.6658">plan_orders(current_positions, target_positions)</text><polygon fill="#A80036" points="2048.5,2396.1809,2058.5,2400.1809,2048.5,2404.1809,2052.5,2400.1809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1854.5" x2="2054.5" y1="2400.1809" y2="2400.1809"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="1861.5" y="2394.3719">get_positions()</text><polygon fill="#A80036" points="193.5,2427.8869,183.5,2431.8869,193.5,2435.8869,189.5,2431.8869" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="187.5" x2="1848.5" y1="2431.8869" y2="2431.8869"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="199.5" y="2426.0779">Dict[instrument_id, Position]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1849.5" x2="1891.5" y1="2463.5929" y2="2463.5929"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1891.5" x2="1891.5" y1="2463.5929" y2="2476.5929"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1850.5" x2="1891.5" y1="2476.5929" y2="2476.5929"/><polygon fill="#A80036" points="1860.5,2472.5929,1850.5,2476.5929,1860.5,2480.5929,1856.5,2476.5929" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="1856.5" y="2457.7839">_compute_deltas(current, target)</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1849.5" x2="1891.5" y1="2513.2989" y2="2513.2989"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1891.5" x2="1891.5" y1="2513.2989" y2="2526.2989"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1844.5" x2="1891.5" y1="2526.2989" y2="2526.2989"/><polygon fill="#A80036" points="1854.5,2522.2989,1844.5,2526.2989,1854.5,2530.2989,1850.5,2526.2989" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="1856.5" y="2507.4899">List[Order]</text><path d="M110.5,2536.2989 L183.5,2536.2989 L183.5,2545.2989 L173.5,2555.2989 L110.5,2555.2989 L110.5,2536.2989 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="172.5301" style="stroke: #000000; stroke-width: 2.0;" width="2159" x="110.5" y="2536.2989"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="125.5" y="2551.1959">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="88" x="198.5" y="2550.0578">[for each order]</text><polygon fill="#A80036" points="2043.5,2575.7109,2053.5,2579.7109,2043.5,2583.7109,2047.5,2579.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="2049.5" y1="2579.7109" y2="2579.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="189.5" y="2573.9019">submit_order(order)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2065.5" x2="2107.5" y1="2611.417" y2="2611.417"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2107.5" x2="2107.5" y1="2611.417" y2="2624.417"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2066.5" x2="2107.5" y1="2624.417" y2="2624.417"/><polygon fill="#A80036" points="2076.5,2620.417,2066.5,2624.417,2076.5,2628.417,2072.5,2624.417" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="2072.5" y="2605.608">pending_orders.append(order)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2065.5" x2="2107.5" y1="2656.123" y2="2656.123"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2107.5" x2="2107.5" y1="2656.123" y2="2669.123"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2066.5" x2="2107.5" y1="2669.123" y2="2669.123"/><polygon fill="#A80036" points="2076.5,2665.123,2066.5,2669.123,2076.5,2673.123,2072.5,2669.123" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="2072.5" y="2650.314">log_order_to_memory()</text><polygon fill="#A80036" points="193.5,2696.829,183.5,2700.829,193.5,2704.829,189.5,2700.829" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="187.5" x2="2059.5" y1="2700.829" y2="2700.829"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="199.5" y="2695.02">order_id</text><polygon fill="#A80036" points="2043.5,2735.535,2053.5,2739.535,2043.5,2743.535,2047.5,2739.535" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="2049.5" y1="2739.535" y2="2739.535"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="189.5" y="2733.726">process_fills(current_date)</text><path d="M110.5,2754.535 L183.5,2754.535 L183.5,2763.535 L173.5,2773.535 L110.5,2773.535 L110.5,2754.535 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="526.5902" style="stroke: #000000; stroke-width: 2.0;" width="2493" x="110.5" y="2754.535"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="125.5" y="2769.432">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="198.5" y="2768.2939">[for each pending order]</text><polygon fill="#A80036" points="2266.5,2793.947,2276.5,2797.947,2266.5,2801.947,2270.5,2797.947" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2065.5" x2="2272.5" y1="2797.947" y2="2797.947"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="2072.5" y="2792.138">simulate_fill(order, current_date)</text><polygon fill="#A80036" points="474.5,2825.6531,464.5,2829.6531,474.5,2833.6531,470.5,2829.6531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="468.5" x2="2277.5" y1="2829.6531" y2="2829.6531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="480.5" y="2823.844">get_data("prices_daily", {instrument_id, date=current_date})</text><polygon fill="#A80036" points="2535.5,2875.0651,2545.5,2879.0651,2535.5,2883.0651,2539.5,2879.0651" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="463.5" x2="2541.5" y1="2879.0651" y2="2879.0651"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="470.5" y="2855.5501">SELECT * FROM prices_daily</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="476.5" y="2873.2561">WHERE instrument_id=... AND date=current_date</text><polygon fill="#A80036" points="2076.5,2906.7711,2066.5,2910.7711,2076.5,2914.7711,2072.5,2910.7711" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="2070.5" x2="2282.5" y1="2910.7711" y2="2910.7711"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="2082.5" y="2904.9621">price_data</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2283.5" x2="2325.5" y1="2942.4771" y2="2942.4771"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2325.5" x2="2325.5" y1="2942.4771" y2="2955.4771"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2284.5" x2="2325.5" y1="2955.4771" y2="2955.4771"/><polygon fill="#A80036" points="2294.5,2951.4771,2284.5,2955.4771,2294.5,2959.4771,2290.5,2955.4771" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="2290.5" y="2936.6681">_apply_slippage(close_price, order)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2283.5" x2="2325.5" y1="2987.1831" y2="2987.1831"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2325.5" x2="2325.5" y1="2987.1831" y2="3000.1831"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2284.5" x2="2325.5" y1="3000.1831" y2="3000.1831"/><polygon fill="#A80036" points="2294.5,2996.1831,2284.5,3000.1831,2294.5,3004.1831,2290.5,3000.1831" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="2290.5" y="2981.3741">_check_volume_constraint(order, volume)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2283.5" x2="2325.5" y1="3031.8892" y2="3031.8892"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2325.5" x2="2325.5" y1="3031.8892" y2="3044.8892"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2284.5" x2="2325.5" y1="3044.8892" y2="3044.8892"/><polygon fill="#A80036" points="2294.5,3040.8892,2284.5,3044.8892,2294.5,3048.8892,2290.5,3044.8892" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="2290.5" y="3026.0801">fill_price = close * (1 + slippage_bps/10000)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2283.5" x2="2325.5" y1="3094.3012" y2="3094.3012"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2325.5" x2="2325.5" y1="3094.3012" y2="3107.3012"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2284.5" x2="2325.5" y1="3107.3012" y2="3107.3012"/><polygon fill="#A80036" points="2294.5,3103.3012,2284.5,3107.3012,2294.5,3111.3012,2290.5,3107.3012" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="2290.5" y="3070.7862">fill_qty = order.quantity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="2296.5" y="3088.4922">(or partial if volume constraint)</text><polygon fill="#A80036" points="193.5,3135.0072,183.5,3139.0072,193.5,3143.0072,189.5,3139.0072" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="187.5" x2="2059.5" y1="3139.0072" y2="3139.0072"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="199.5" y="3133.1982">Fill(price=fill_price, qty=fill_qty)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2060.5" x2="2102.5" y1="3170.7132" y2="3170.7132"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2102.5" x2="2102.5" y1="3170.7132" y2="3183.7132"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2061.5" x2="2102.5" y1="3183.7132" y2="3183.7132"/><polygon fill="#A80036" points="2071.5,3179.7132,2061.5,3183.7132,2071.5,3187.7132,2067.5,3183.7132" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="2067.5" y="3164.9042">update_positions(fill)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2060.5" x2="2102.5" y1="3215.4192" y2="3215.4192"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2102.5" x2="2102.5" y1="3215.4192" y2="3228.4192"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2061.5" x2="2102.5" y1="3228.4192" y2="3228.4192"/><polygon fill="#A80036" points="2071.5,3224.4192,2061.5,3228.4192,2071.5,3232.4192,2067.5,3228.4192" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="2067.5" y="3209.6102">update_cash(fill.price * fill.qty)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2060.5" x2="2102.5" y1="3260.1253" y2="3260.1253"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2102.5" x2="2102.5" y1="3260.1253" y2="3273.1253"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2061.5" x2="2102.5" y1="3273.1253" y2="3273.1253"/><polygon fill="#A80036" points="2071.5,3269.1253,2061.5,3273.1253,2071.5,3277.1253,2067.5,3273.1253" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="2067.5" y="3254.3162">log_fill_to_memory()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2060.5" x2="2102.5" y1="3311.8313" y2="3311.8313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2102.5" x2="2102.5" y1="3311.8313" y2="3324.8313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2061.5" x2="2102.5" y1="3324.8313" y2="3324.8313"/><polygon fill="#A80036" points="2071.5,3320.8313,2061.5,3324.8313,2071.5,3328.8313,2067.5,3324.8313" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="2067.5" y="3306.0223">pending_orders.clear()</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="2060.5" x2="2102.5" y1="3361.5373" y2="3361.5373"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="2102.5" x2="2102.5" y1="3361.5373" y2="3374.5373"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="2055.5" x2="2102.5" y1="3374.5373" y2="3374.5373"/><polygon fill="#A80036" points="2065.5,3370.5373,2055.5,3374.5373,2065.5,3378.5373,2061.5,3374.5373" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="2067.5" y="3355.7283">fills_processed</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="224.5" y1="3472.0674" y2="3472.0674"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="224.5" x2="224.5" y1="3472.0674" y2="3485.0674"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="183.5" x2="224.5" y1="3485.0674" y2="3485.0674"/><polygon fill="#A80036" points="193.5,3481.0674,183.5,3485.0674,193.5,3489.0674,189.5,3485.0674" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="189.5" y="3395.4343">log_snapshot(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="195.5" y="3413.1403">date=current_date,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="195.5" y="3430.8463">portfolio_value=broker.get_account_state(),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="195.5" y="3448.5523">positions=broker.get_positions()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189.5" y="3466.2584">)</text><polygon fill="#A80036" points="451.5,3512.7734,461.5,3516.7734,451.5,3520.7734,455.5,3516.7734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="457.5" y1="3516.7734" y2="3516.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="189.5" y="3510.9644">advance_to_next_trading_day()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="463.5" x2="505.5" y1="3548.4794" y2="3548.4794"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="505.5" x2="505.5" y1="3548.4794" y2="3561.4794"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="464.5" x2="505.5" y1="3561.4794" y2="3561.4794"/><polygon fill="#A80036" points="474.5,3557.4794,464.5,3561.4794,474.5,3565.4794,470.5,3561.4794" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="470.5" y="3542.6704">current_date = next_trading_day(current_date)</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="463.5" x2="505.5" y1="3609.3914" y2="3609.3914"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="505.5" x2="505.5" y1="3609.3914" y2="3622.3914"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="464.5" x2="505.5" y1="3622.3914" y2="3622.3914"/><polygon fill="#A80036" points="474.5,3618.3914,464.5,3622.3914,474.5,3626.3914,470.5,3622.3914" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="470.5" y="3603.5824">new_date</text><path d="M540,3574.4794 L540,3637.4794 L780,3637.4794 L780,3584.4794 L770,3574.4794 L540,3574.4794 " fill="#FBFB77" filter="url(#f19844tg0jdx0b)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M770,3574.4794 L770,3584.4794 L780,3584.4794 L770,3574.4794 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="546" y="3593.3764">Loop continues...</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="546" y="3611.0824">TimeMachine ensures no look-ahead</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="546" y="3628.7884">at every data access</text><rect fill="#EEEEEE" filter="url(#f19844tg0jdx0b)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2620.5" x="3" y="3675.4505"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2623.5" y1="3675.4505" y2="3675.4505"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2623.5" y1="3678.4505" y2="3678.4505"/><rect fill="#EEEEEE" filter="url(#f19844tg0jdx0b)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="223" x="1201.75" y="3663.5975"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="1207.75" y="3681.4945">Backtest Completion &amp; Analysis</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="224.5" y1="3793.8335" y2="3793.8335"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="224.5" x2="224.5" y1="3793.8335" y2="3806.8335"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="183.5" x2="224.5" y1="3806.8335" y2="3806.8335"/><polygon fill="#A80036" points="193.5,3802.8335,183.5,3806.8335,193.5,3810.8335,189.5,3806.8335" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="189.5" y="3717.2005">compute_performance_metrics(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="195.5" y="3734.9065">snapshots,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="195.5" y="3752.6125">fills,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="195.5" y="3770.3185">decisions</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189.5" y="3788.0245">)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="182.5" x2="224.5" y1="3944.7757" y2="3944.7757"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="224.5" x2="224.5" y1="3944.7757" y2="3957.7757"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="183.5" x2="224.5" y1="3957.7757" y2="3957.7757"/><polygon fill="#A80036" points="193.5,3953.7757,183.5,3957.7757,193.5,3961.7757,189.5,3957.7757" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="189.5" y="3832.7306">generate_report(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="195.5" y="3850.4366">total_return,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="195.5" y="3868.1426">sharpe_ratio,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="195.5" y="3885.8486">max_drawdown,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="195.5" y="3903.5546">turnover,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="195.5" y="3921.2606">regime_breakdown</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189.5" y="3938.9667">)</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="182.5" x2="224.5" y1="3994.4817" y2="3994.4817"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="224.5" x2="224.5" y1="3994.4817" y2="4007.4817"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="177.5" x2="224.5" y1="4007.4817" y2="4007.4817"/><polygon fill="#A80036" points="187.5,4003.4817,177.5,4007.4817,187.5,4011.4817,183.5,4007.4817" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="189.5" y="3988.6727">BacktestResult</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="41.5" x2="83.5" y1="4069.5997" y2="4069.5997"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="83.5" x2="83.5" y1="4069.5997" y2="4082.5997"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="42.5" x2="83.5" y1="4082.5997" y2="4082.5997"/><polygon fill="#A80036" points="52.5,4078.5997,42.5,4082.5997,52.5,4086.5997,48.5,4082.5997" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="48.5" y="4028.3787">Analyze results,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="48.5" y="4046.0847">adjust configs,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="48.5" y="4063.7907">run new experiments</text><!--MD5=[d297847db004500803c8988554bfea07]
@startuml Backtesting Flow

title Prometheus v2 - Backtesting Flow with TimeMachine

actor User
participant "BacktestRunner" as Runner
participant "TimeMachine" as TM
participant "RegimeEngine" as Regime
participant "StabilityEngine" as Stab
participant "AssessmentEngine" as Assess
participant "UniverseEngine" as Univ
participant "PortfolioEngine" as Port
participant "OrderPlanner" as Planner
participant "BacktestBroker" as Broker
participant "MarketSimulator" as Sim
database "historical_db" as HDB

== Backtest Initialization ==

User -> Runner: run_backtest(\n  start=2020-01-01,\n  end=2023-12-31,\n  strategy="main",\n  initial_cash=1M\n)
activate Runner

Runner -> TM: __init__(start_date, end_date)
activate TM
TM -> TM: _load_trading_calendar()
TM -> TM: current_date = start_date
return TimeMachine initialized

Runner -> Broker: __init__(time_machine=TM, initial_cash=1M)
activate Broker
Broker -> Broker: portfolio_value = initial_cash
Broker -> Broker: positions = {}
Broker -> Broker: pending_orders = []
return BacktestBroker initialized

== Main Backtest Loop ==

loop for each trading day in [2020-01-01, 2023-12-31]
    
    Runner -> TM: set_date(current_date)
    activate TM
    TM -> TM: current_date = date
    TM -> TM: _validate_no_lookahead()
    return OK
    
    note right: All subsequent data access\nis gated by TimeMachine.\nNo future data accessible!
    
    Runner -> Regime: get_regime(as_of_date=current_date, region="US")
    activate Regime
    
    Regime -> TM: get_data("prices_daily", filters={...})
    activate TM
    TM -> TM: _check_date_constraint(current_date)
    TM -> HDB: SELECT * FROM prices_daily\n  WHERE date <= current_date
    return DataFrame (time-gated)
    deactivate TM
    
    Regime -> Regime: embed_regime_window(...)
    Regime -> Regime: classify_regime(embedding)
    return RegimeState
    
    deactivate Regime
    
    Runner -> Stab: compute_stability_batch(entities, current_date)
    activate Stab
    
    Stab -> TM: get_data("profiles", filters={...})
    TM -> HDB: SELECT * FROM profiles\n  WHERE as_of_date <= current_date
    return List[ProfileSnapshot]
    
    Stab -> Stab: _compute_liquidity_score(...)
    Stab -> Stab: _compute_volatility_score(...)
    return Dict[entity_id, StabilityVector]
    
    deactivate Stab
    
    Runner -> Assess: score_strategy_default("main", "US_EQ", current_date)
    activate Assess
    
    Assess -> TM: get_data("returns_daily", filters={...})
    TM -> HDB: SELECT * FROM returns_daily\n  WHERE date <= current_date
    return DataFrame
    
    Assess -> Assess: _compute_value_alpha(...)
    Assess -> Assess: _compute_momentum_alpha(...)
    Assess -> Assess: _combine_alphas(...)
    return Dict[instrument_id, InstrumentScore]
    
    deactivate Assess
    
    Runner -> Univ: select("main", "US_EQ", current_date)
    activate Univ
    
    Univ -> Assess: get_scores("main", "US_EQ", current_date)
    return Dict[instrument_id, InstrumentScore]
    
    Univ -> Univ: filter_by_liquidity(...)
    Univ -> Univ: _assign_tiers(...)
    return Universe(core, satellite, watchlist)
    
    deactivate Univ
    
    Runner -> Port: optimize("main", current_date, universe, scores)
    activate Port
    
    Port -> TM: get_data("correlation_panels", filters={...})
    TM -> HDB: SELECT * FROM correlation_panels\n  WHERE end_date <= current_date
    return correlation_matrix
    
    Port -> Port: _build_optimization_problem(...)
    Port -> Port: _solve_cvxpy(problem)
    return Dict[instrument_id, target_weight]
    
    deactivate Port
    
    Runner -> Planner: plan_orders(current_positions, target_positions)
    activate Planner
    
    Planner -> Broker: get_positions()
    return Dict[instrument_id, Position]
    
    Planner -> Planner: _compute_deltas(current, target)
    return List[Order]
    
    deactivate Planner
    
    loop for each order
        Runner -> Broker: submit_order(order)
        activate Broker
        
        Broker -> Broker: pending_orders.append(order)
        Broker -> Broker: log_order_to_memory()
        
        return order_id
        
        deactivate Broker
    end
    
    Runner -> Broker: process_fills(current_date)
    activate Broker
    
    loop for each pending order
        Broker -> Sim: simulate_fill(order, current_date)
        activate Sim
        
        Sim -> TM: get_data("prices_daily", {instrument_id, date=current_date})
        TM -> HDB: SELECT * FROM prices_daily\n  WHERE instrument_id=... AND date=current_date
        return price_data
        
        Sim -> Sim: _apply_slippage(close_price, order)
        Sim -> Sim: _check_volume_constraint(order, volume)
        
        Sim -> Sim: fill_price = close * (1 + slippage_bps/10000)
        Sim -> Sim: fill_qty = order.quantity\n  (or partial if volume constraint)
        
        return Fill(price=fill_price, qty=fill_qty)
        
        deactivate Sim
        
        Broker -> Broker: update_positions(fill)
        Broker -> Broker: update_cash(fill.price * fill.qty)
        Broker -> Broker: log_fill_to_memory()
    end
    
    Broker -> Broker: pending_orders.clear()
    return fills_processed
    
    deactivate Broker
    
    Runner -> Runner: log_snapshot(\n  date=current_date,\n  portfolio_value=broker.get_account_state(),\n  positions=broker.get_positions()\n)
    
    Runner -> TM: advance_to_next_trading_day()
    TM -> TM: current_date = next_trading_day(current_date)
    return new_date
    
    note right: Loop continues...\nTimeMachine ensures no look-ahead\nat every data access
    
end

== Backtest Completion & Analysis ==

Runner -> Runner: compute_performance_metrics(\n  snapshots,\n  fills,\n  decisions\n)

Runner -> Runner: generate_report(\n  total_return,\n  sharpe_ratio,\n  max_drawdown,\n  turnover,\n  regime_breakdown\n)

return BacktestResult

deactivate Runner

User -> User: Analyze results,\nadjust configs,\nrun new experiments

@enduml

PlantUML version 1.2020.02(Sun Mar 01 11:22:07 CET 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 21.0.9+10-Debian-1
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>